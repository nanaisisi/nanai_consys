# コーディングルール（AI 支援前提・軽量版）

本リポジトリでは、人と AI の共同開発を前提に、具体的な細目は AI が状況に応じて提案・補完できるよう、原則・分割方針・インターフェイス規約を軽量に定義します。

## 1. 原則（Definition）

- 小さく作り、早く動かし、計測する（Small, Working, Measured）。
- 可読性>賢さ：読みやすい命名・直線的なロジックを優先。
- ローカル最適でも良い：無用な汎用化は避ける。必要時に抽象化。
- 収集 → 判断 → 適用の分離（observer/decider/applier）。
- 監査可能性：重要な入出力は NDJSON で記録。

## 2. 分割化（Modularization）

- 層分割
  - collect: 実測の取得（例：Nushell `sys`、ベンダー CLI）。
  - eval: 前処理・統計・特徴量化。
  - decide: 閾値または AI での意思決定（フォールバック必須）。
  - apply: 設定適用（環境変数/引数/設定ファイル）。
- 単一責務：モジュール/スクリプトは 1 つの責務に集中。
- ファイル構成（例）
  - `scripts/monitor.nu`（collect+軽い decide）
  - `scripts/tune_example.nu`（decide/eval）
  - `scripts/ai_adapter.nu`（decide: AI 呼び出し、将来追加）
  - `doc/*.md`（仕様と運用）

## 3. インターフェイス（Interface）

- データ交換
  - JSON/NDJSON を基本形式とする。
  - スキーマは「緩い前方互換」を原則（未知キーは無視、必要キーは既定値）。
- コマンド I/F
  - CLI は「標準入力 JSON→ 標準出力 JSON」を推奨。
  - 失敗時は非 0 終了/非 200（HTTP）。Nu 側で try-catch しフォールバック。
- 閾値フォールバック
  - level: low/mid/high（50%/80%目安）で最小限の動作を保証。
  - AI エラー時は必ずフォールバックを適用。

## 4. スタイル（Style）

- 命名：役割が分かる短く一貫した英語（e.g., collect, eval, decide, apply）。
- 関数：入力/出力の「契約」を冒頭コメントで 2〜4 行に要約。
- 例外：外部実行は`try`でガードし、null/既定値で継続。
- ログ：意思決定の入力と出力を 1 行 JSON で残す。

## 5. テスト/検証（Quality）

- Quality gates：
  - Lint/構文: スクリプトの構文エラーは即修正。
  - スモーク: 代表的 1〜2 ケースで実行確認。
  - 回帰: 入力 → 出力の固定ペアを NDJSON で残し比較可能に。

## 6. AI に委譲する細目（任意）

- しきい値の微調整、特徴量の追加、探索パラメータ（学習率/バッチ/並列度の上限など）。
- 例外時のリトライ戦略・ヒステリシス幅。
- アプリ別プロファイル（テンプレート）の提案と適用。

## 7. 変更手順（Workflow）

1. 仕様差分を`doc/`に 1 パラグラフで追記。
2. 最小の追加/変更を実装（既存 I/F を壊さない）。
3. スモークテストとログ確認。
4. 大きな変更は AI にドラフト生成 → 人がレビュー。

---

注：このドキュメントは「原則と I/F」を固定し、細目は AI が状況最適に提案・更新する運用を想定しています。
